<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Give House Points</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    label, select, button {
      display: block;
      margin: 1rem 0;
    }
    .points-section label {
      display: inline-block;
      margin-right: 1rem;
    }
  </style>
</head>
<body>
  <h1>Give House Points</h1>

  <label for="classSelect">Select Class:</label>
  <select id="classSelect">
    <option selected disabled>Select a class...</option>
  </select>

  <label for="studentSelect" style="display:none;">Select Student:</label>
  <select id="studentSelect" style="display:none;"></select>

  <div class="points-section" id="pointOptions" style="display:none;">
    <h3>Industry Points</h3>
    <label><input type="radio" name="indPoints" value="1"> +1</label>
    <label><input type="radio" name="indPoints" value="2"> +2</label>
    <label><input type="radio" name="indPoints" value="3"> +3</label>

    <h3>Citizenship Points</h3>
    <label><input type="radio" name="citPoints" value="1"> +1</label>
    <label><input type="radio" name="citPoints" value="2"> +2</label>
    <label><input type="radio" name="citPoints" value="3"> +3</label>

    <button id="submitBtn">Submit</button>
  </div>

  <p id="status"></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBJfBxrgo6rg8uXL9PIgY6ebL3gFGS3TI8",
      authDomain: "house-point-system-lfairclo.firebaseapp.com",
      databaseURL: "https://house-point-system-lfairclo-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "house-point-system-lfairclo",
      storageBucket: "house-point-system-lfairclo.firebasestorage.app",
      messagingSenderId: "941089391114",
      appId: "1:941089391114:web:028c06d8789846c72195f3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const appCheck = initializeAppCheck(app, {
        provider: new ReCaptchaV3Provider('6LfJBmgrAAAAAOXs8gR2yQf6Hw34cmAkY_gBizP0'),
        isTokenAutoRefreshEnabled: true
      });
    
    const classSelect = document.getElementById("classSelect");
    const studentSelect = document.getElementById("studentSelect");
    const pointOptions = document.getElementById("pointOptions");
    const status = document.getElementById("status");

    let teacherID = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const teacherSnap = await get(ref(db, `teachers/${user.uid}/id`));
      teacherID = teacherSnap.exists() ? teacherSnap.val() : null;
      if (!teacherID) {
        status.textContent = "Error: You must be a teacher to give points.";
      }
    });

    async function loadClasses() {
      const snapshot = await get(ref(db, 'classes'));
      if (snapshot.exists()) {
        const classes = snapshot.val();
        for (let className in classes) {
          const option = document.createElement("option");
          option.value = className;
          option.textContent = className;
          classSelect.appendChild(option);
        }
      }
    }

    classSelect.addEventListener("change", async () => {
      studentSelect.innerHTML = "";
      studentSelect.style.display = "none";
      pointOptions.style.display = "none";

      const selectedClass = classSelect.value;
      const studentSnap = await get(ref(db, 'students'));
      if (studentSnap.exists()) {
        const allStudents = studentSnap.val();
        for (let uid in allStudents) {
          const student = allStudents[uid];
          if (student.class === selectedClass) {
            const option = document.createElement("option");
            option.value = uid;
            option.textContent = student.name || uid;
            studentSelect.appendChild(option);
          }
        }
        if (studentSelect.options.length > 0) {
          studentSelect.style.display = "block";
          document.querySelector("label[for='studentSelect']").style.display = "block";
        }
      }
    });

    studentSelect.addEventListener("change", () => {
      pointOptions.style.display = "block";
    });

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const uid = studentSelect.value;
      if (!uid || !teacherID) return;

      const indVal = document.querySelector("input[name='indPoints']:checked")?.value;
      const citVal = document.querySelector("input[name='citPoints']:checked")?.value;

      const updates = {};

      const appendPoints = async (path, amount) => {
        const snap = await get(ref(db, `${path}`));
        const existing = snap.exists() ? snap.val() : [];
        const updated = existing.concat(Array(parseInt(amount)).fill(teacherID));
        updates[path] = updated;
      };

      if (indVal) await appendPoints(`students/${uid}/ind`, indVal);
      if (citVal) await appendPoints(`students/${uid}/cit`, citVal);

      await update(ref(db), updates);
      status.textContent = "Points successfully added!";
    });

    loadClasses();
  </script>
</body>
</html>
